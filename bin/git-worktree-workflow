#!/bin/bash
# git-worktree-workflow - Safe parallel development with Git worktrees
#
# Ensures developers and Claude Code sessions never work directly on main/master.
# Creates isolated worktrees for feature branches to enable parallel work.
#
# Commands:
#   validate  - Check current git context (main repo vs worktree, branch status)
#   start     - Create a worktree for a feature branch
#   main      - Show how to return to main repo
#   cleanup   - Remove worktrees for merged branches
#   list      - List all worktrees
#
# Usage:
#   git-worktree-workflow validate
#   git-worktree-workflow start feat/issue-123-description
#   git-worktree-workflow cleanup
#
# Environment:
#   WORKTREE_BASE - Override default worktree location (default: ../REPO-worktrees)

set -e

# Configuration
MAIN_BRANCHES="main master"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ensure we're in a git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

# Get worktree base directory
get_worktree_base() {
    if [ -n "$WORKTREE_BASE" ]; then
        echo "$WORKTREE_BASE"
    else
        local repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
        local repo_name=$(basename "$repo_root")
        local parent_dir=$(dirname "$repo_root")
        echo "$parent_dir/${repo_name}-worktrees"
    fi
}

get_main_branch() {
    for branch in $MAIN_BRANCHES; do
        if git show-ref --verify --quiet "refs/heads/$branch"; then
            echo "$branch"
            return 0
        fi
    done
    # Check remote
    for branch in $MAIN_BRANCHES; do
        if git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
            echo "$branch"
            return 0
        fi
    done
    echo "main"  # Default fallback
}

get_repo_type() {
    local git_dir=$(git rev-parse --git-dir 2>/dev/null)

    # Check if we're in a worktree (git-dir contains "worktrees")
    if [[ "$git_dir" == *"/worktrees/"* ]]; then
        echo "worktree"
    else
        echo "main-repo"
    fi
}

cmd_validate() {
    local repo_type=$(get_repo_type)
    local current_branch=$(git branch --show-current)
    local main_branch=$(get_main_branch)
    local repo_root=$(git rev-parse --show-toplevel 2>/dev/null)

    echo -e "${BLUE}=== Git Worktree Workflow Validation ===${NC}"
    echo ""
    echo "Repository: $(basename "$repo_root")"
    echo "Type: $repo_type"
    echo "Branch: $current_branch"
    echo "Main branch: $main_branch"
    echo ""

    if [[ "$repo_type" == "worktree" ]]; then
        echo -e "${GREEN}✓ Working in a worktree - session is isolated${NC}"
        echo "  Path: $repo_root"
        return 0
    fi

    # We're in main repo
    if [[ "$current_branch" == "$main_branch" ]]; then
        echo -e "${GREEN}✓ Main repo on $main_branch - ready to create worktree${NC}"
        echo ""
        echo "To start work on a feature:"
        echo "  git-worktree-workflow start feat/your-feature-name"
        return 0
    else
        echo -e "${RED}✗ VIOLATION: Main repo on feature branch '$current_branch'${NC}"
        echo ""
        echo "This breaks parallel work! Other sessions may conflict."
        echo ""
        echo -e "${YELLOW}To fix:${NC}"
        echo "  1. Stash or commit your changes:"
        echo "     git stash push -m 'WIP: $current_branch'"
        echo "  2. Return to $main_branch:"
        echo "     git checkout $main_branch"
        echo "  3. Create a worktree for your branch:"
        echo "     git-worktree-workflow start $current_branch"
        echo "  4. Apply stash in worktree (if needed):"
        echo "     cd <worktree-path> && git stash pop"
        return 1
    fi
}

cmd_start() {
    local branch_name="$1"

    if [[ -z "$branch_name" ]]; then
        echo -e "${RED}Error: Branch name required${NC}"
        echo ""
        echo "Usage: git-worktree-workflow start <branch-name>"
        echo ""
        echo "Examples:"
        echo "  git-worktree-workflow start feat/issue-123-add-login"
        echo "  git-worktree-workflow start fix/issue-456-null-check"
        return 1
    fi

    local repo_type=$(get_repo_type)
    local current_branch=$(git branch --show-current)
    local main_branch=$(get_main_branch)
    local worktree_base=$(get_worktree_base)

    # Validate we're in the right context
    if [[ "$repo_type" == "worktree" ]]; then
        echo -e "${RED}Error: Already in a worktree${NC}"
        echo ""
        echo "Return to main repo first:"
        echo "  git-worktree-workflow main"
        return 1
    fi

    if [[ "$current_branch" != "$main_branch" ]]; then
        echo -e "${RED}Error: Must be on $main_branch to create worktree${NC}"
        echo ""
        echo "Run: git checkout $main_branch"
        return 1
    fi

    # Ensure we have latest main
    echo -e "${BLUE}Fetching latest from origin...${NC}"
    git fetch origin
    git pull origin "$main_branch" --ff-only 2>/dev/null || true

    # Create worktree directory path (sanitize branch name for path)
    local worktree_dir="$worktree_base/$(echo "$branch_name" | tr '/' '-')"

    # Check if worktree already exists
    if [[ -d "$worktree_dir" ]]; then
        echo -e "${YELLOW}Worktree already exists at: $worktree_dir${NC}"
        echo ""
        echo "To use it:"
        echo "  cd $worktree_dir"
        echo ""
        echo "To remove it:"
        echo "  git worktree remove $worktree_dir"
        return 1
    fi

    # Create the worktree base directory
    mkdir -p "$worktree_base"

    # Check if branch exists remotely or locally
    if git show-ref --verify --quiet "refs/heads/$branch_name"; then
        echo "Using existing local branch: $branch_name"
        git worktree add "$worktree_dir" "$branch_name"
    elif git show-ref --verify --quiet "refs/remotes/origin/$branch_name"; then
        echo "Using existing remote branch: $branch_name"
        git worktree add "$worktree_dir" "$branch_name"
    else
        echo "Creating new branch: $branch_name (from $main_branch)"
        git worktree add -b "$branch_name" "$worktree_dir" "$main_branch"
    fi

    echo ""
    echo -e "${GREEN}✓ Worktree created successfully${NC}"
    echo ""
    echo "  Path: $worktree_dir"
    echo "  Branch: $branch_name"
    echo ""
    echo -e "${YELLOW}IMPORTANT: Change to the worktree directory:${NC}"
    echo "  cd $worktree_dir"
    echo ""
    echo "Then verify isolation:"
    echo "  git-worktree-workflow validate"
}

cmd_main() {
    local repo_type=$(get_repo_type)

    if [[ "$repo_type" == "main-repo" ]]; then
        echo "Already in main repo: $(git rev-parse --show-toplevel)"
    else
        # Find the main repo path from worktree
        local git_dir=$(git rev-parse --git-dir)
        # Navigate from .git/worktrees/<name> back to main repo's .git, then up
        local main_git_dir=$(dirname "$(dirname "$git_dir")")
        local main_repo=$(dirname "$main_git_dir")

        echo -e "${BLUE}Main repo location:${NC}"
        echo "  $main_repo"
        echo ""
        echo "To return to main repo:"
        echo "  cd $main_repo"
    fi

    local main_branch=$(get_main_branch)
    local current_branch=$(git branch --show-current)

    if [[ "$current_branch" != "$main_branch" ]]; then
        echo ""
        echo "Then checkout $main_branch:"
        echo "  git checkout $main_branch"
    fi
}

cmd_cleanup() {
    echo -e "${BLUE}=== Cleaning up merged worktrees ===${NC}"
    echo ""

    local main_branch=$(get_main_branch)
    local cleaned=0
    local kept=0

    # List all worktrees
    while IFS= read -r line; do
        local worktree_path=$(echo "$line" | awk '{print $1}')
        local worktree_branch=$(echo "$line" | grep -oP '\[.*\]' | tr -d '[]')

        # Skip if no branch (bare/detached) or if it's the main worktree
        if [[ -z "$worktree_branch" ]]; then
            continue
        fi

        # Skip main branch
        if [[ "$worktree_branch" == "$main_branch" ]]; then
            continue
        fi

        # Check if branch is merged into main
        if git branch --merged "$main_branch" 2>/dev/null | grep -q "^\s*$worktree_branch$"; then
            echo -e "${GREEN}Removing:${NC} $worktree_path ($worktree_branch) - merged"
            git worktree remove "$worktree_path" --force 2>/dev/null || true
            git branch -d "$worktree_branch" 2>/dev/null || true
            ((cleaned++))
        else
            echo -e "${YELLOW}Keeping:${NC} $worktree_path ($worktree_branch) - not merged"
            ((kept++))
        fi
    done < <(git worktree list)

    # Prune stale worktree references
    git worktree prune

    echo ""
    if [[ $cleaned -eq 0 ]] && [[ $kept -eq 0 ]]; then
        echo "No worktrees to process"
    else
        echo -e "${GREEN}Cleaned: $cleaned${NC} | ${YELLOW}Kept: $kept${NC}"
    fi
}

cmd_list() {
    echo -e "${BLUE}=== Git Worktrees ===${NC}"
    echo ""
    git worktree list
    echo ""

    local worktree_base=$(get_worktree_base)
    echo "Worktree base directory: $worktree_base"
}

# Main command dispatcher
case "${1:-}" in
    validate|v)
        cmd_validate
        ;;
    start|s)
        cmd_start "$2"
        ;;
    main|m)
        cmd_main
        ;;
    cleanup|c)
        cmd_cleanup
        ;;
    list|l|ls)
        cmd_list
        ;;
    -h|--help|help)
        echo "git-worktree-workflow - Safe parallel development with Git worktrees"
        echo ""
        echo "Usage: git-worktree-workflow <command> [args]"
        echo ""
        echo "Commands:"
        echo "  validate, v       Check current git context"
        echo "  start, s <branch> Create worktree for feature branch"
        echo "  main, m           Show how to return to main repo"
        echo "  cleanup, c        Remove worktrees for merged branches"
        echo "  list, l, ls       List all worktrees"
        echo ""
        echo "Examples:"
        echo "  git-worktree-workflow validate"
        echo "  git-worktree-workflow start feat/issue-123-fix-bug"
        echo "  git-worktree-workflow cleanup"
        echo ""
        echo "Environment:"
        echo "  WORKTREE_BASE     Override worktree directory location"
        echo ""
        echo "The script ensures you never work on main/master in the main repo,"
        echo "preventing conflicts between parallel Claude Code sessions."
        ;;
    *)
        echo "git-worktree-workflow - Safe parallel development with Git worktrees"
        echo ""
        echo "Usage: git-worktree-workflow <command> [args]"
        echo ""
        echo "Commands:"
        echo "  validate    Check current git context"
        echo "  start       Create worktree for feature branch"
        echo "  main        Show how to return to main repo"
        echo "  cleanup     Remove worktrees for merged branches"
        echo "  list        List all worktrees"
        echo ""
        echo "Run 'git-worktree-workflow --help' for more details"
        ;;
esac
